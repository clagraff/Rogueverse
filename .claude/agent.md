# Agent Guidelines for rogueverse

## Build & Test Commands
- `flutter run` - Run the app
- `flutter test` - Run all tests
- `flutter test test/widget_test.dart` - Run a single test file
- `flutter analyze` - Lint the codebase
- `dart run build_runner build` - Generate mapper files for dart_mappable

The app should NEVER be ran (`flutter run`) without explicit instructions to
do so.

**Prefer `flutter analyze` over `flutter build`** - building takes too long and analyze is sufficient for catching most issues.

For `flutter analyze`, prefer running it over the specific files changed (if any)
instead of the whole project for speed & efficiency.

After making changes, run `flutter analyze` to catch and fix:
- Unused imports
- Unnecessary imports (duplicates from re-exporting files)
- Unused variables/fields
- Other lint warnings

## Code Style

### Imports
- Use `package:rogueverse/` for all internal imports (never relative imports)
- Group imports: dart, flutter/flame, packages, project (separated by blank lines)
- Hide conflicting imports explicitly (e.g., `import 'package:flame/components.dart' hide World;`)
- Use `ecs/ecs.dart` for ECS imports (it re-exports all ECS modules)
- Remove unnecessary/duplicate imports flagged by `flutter analyze`

### Formatting & Structure
- Use `flutter_lints` rules (configured in `analysis_options.yaml`)

### Auto-Generated Files (DO NOT EDIT MANUALLY)
The following files are auto-generated and should never be edited by hand:
- `*.mapper.dart` - Generated by dart_mappable via build_runner
- `*.init.dart` - Generated by dart_mappable via build_runner

To regenerate these files after changing `@MappableClass()` components:
```bash
dart run build_runner build --delete-conflicting-outputs
```

### Types & Annotations
- All components must use `@MappableClass()` annotation and implement `Component` interface
- Components must define `String get componentType` getter returning their type name
- Use `part 'filename.mapper.dart';` for files with `@MappableClass()` annotations
- Prefer explicit types over `var` for public APIs

### Component Immutability
- **All component properties must be `final` (immutable)**
- When updating state, create a new component instance and `upsert()` it
- Reason: `entity.get<T>()` returns template components by reference, not copy. Mutating them affects all instances inheriting from that template.
- TODO: Audit existing components to ensure all properties are `final`

### Naming Conventions
- Classes: PascalCase (e.g., `LocalPosition`, `MoveByIntent`)
- Files: snake_case matching class name (e.g., `components.dart`, `game_area.dart`)
- Private fields: prefix with underscore (e.g., `_templateEditingWorld`)

### Error Handling
- Use exceptions for invalid state (e.g., `throw Exception("message")`)
- Add TODO comments for future improvements
- Use logging package for runtime logging: `Logger("ClassName").info("message")`
